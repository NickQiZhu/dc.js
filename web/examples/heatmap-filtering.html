<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Heatmap Filtering Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
    <style>
        .heat-box {
            stroke: #E6E6E6;
            stroke-width: 2px;
        }
    </style>
</head>
<body>
<h2>Michelsonâ€“Morley experiment</h2>
<div id="test"></div>
<div id="barTest"></div>

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript">

    var chartGroup = "chartGroup";
    var heatmapChart = dc.heatMap("#test", chartGroup);
    var barChart = dc.barChart("#barTest", chartGroup);

    d3.csv("morley.csv", function(error, experiments) {

        var ndx    = crossfilter(experiments),
                runDim = ndx.dimension(function(d) { return [+d.Run, +d.Expt]; }),
                runGroup = runDim.group().reduceSum(function(d) { return +d.Speed; });

        heatmapChart
                .width(45 * 20 + 80)
                .height(45 * 5 + 40)
                .dimension(runDim)
                .group(runGroup)
                .keyAccessor(function(d) { return +d.key[0]; })
                .valueAccessor(function(d) { return +d.key[1]; })
                .colorAccessor(function(d) { return +d.value; })
                .title(function(d) {
                    return "Run:   " + d.key[0] + "\n" +
                            "Expt:  " + d.key[1] + "\n" +
                            "Speed: " + (299000 + d.value) + " km/s";})
                .colors(["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"])
                .calculateColorDomain();

        heatmapChart.render();

        var actualRunDim = ndx.dimension( function(d) {
            return +d.Run;
        });

        var actualRunGroup = actualRunDim.group().reduce(
            function reduceAdd(p,v) {
                ++p.expts;
                p.total += +v.Speed;
                p.avg = Math.round(p.total / p.expts);
                return p;
            },
            function reduceRemove(p,v) {
                --p.expts;
                p.total -= +v.Speed;
                p.avg = p.expts ?  Math.round(p.total / p.expts) : 0;
                return p;
            },
            function reduceInitial() {
                return {expts: 0, total: 0, avg: 0};
            }
        );

        barChart
                .width(45 * 20 + 80)
                .height(45 * 5 + 40)
                .x(d3.scale.linear().domain([1,21]))
                .y(d3.scale.linear().domain(
                        [d3.min(experiments, function (d) { return +d.Speed; }) - 100,
                         d3.max(experiments, function (d) { return +d.Speed; }) + 100]
                ))
                .dimension(actualRunDim)
                .valueAccessor( function (d) { return d.value.avg; })
                .colorAccessor( function(d) {
                    if(d.value == undefined) return d.data.value.avg;
                    return d.value.avg;
                })
                .group(actualRunGroup)
                .colors(["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"])
                .colorDomain(heatmapChart.colorDomain());

        barChart.render();
    });

</script>

</body>
</html>
